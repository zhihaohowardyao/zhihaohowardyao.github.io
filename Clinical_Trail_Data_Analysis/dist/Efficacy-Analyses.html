<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="generator" content="Observable Framework v1.11.0">
<title>Efficacy Analyses | Clinical Trial Data Analysis</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="./_observablehq/theme-air.9914ee1a.css">
<link rel="preload" as="style" href="./_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="preload" as="style" href="./_npm/katex@0.16.11/dist/katex.min.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="./_observablehq/theme-air.9914ee1a.css">
<link rel="stylesheet" type="text/css" href="./_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="stylesheet" type="text/css" href="./_npm/katex@0.16.11/dist/katex.min.css">
<link rel="modulepreload" href="./_observablehq/client.7e44a896.js">
<link rel="modulepreload" href="./_observablehq/runtime.c916ad99.js">
<link rel="modulepreload" href="./_observablehq/stdlib.3783f355.js">
<link rel="modulepreload" href="./_import/components/summaryTable.bd8e7950.js">
<link rel="modulepreload" href="./_npm/d3@7.9.0/7055d4c5.js">
<link rel="modulepreload" href="./_npm/lodash@4.17.21/cbfa4f05.js">
<link rel="modulepreload" href="./_npm/@observablehq/plot@0.6.16/e828d8c8.js">
<link rel="modulepreload" href="./_npm/htl@0.3.1/063eb405.js">
<link rel="modulepreload" href="./_npm/arquero@6.0.1/307e9056.js">
<link rel="modulepreload" href="./_observablehq/stdlib/inputs.e3f2dfe6.js">
<link rel="modulepreload" href="./_observablehq/stdlib/tex.c8bffae1.js">
<link rel="modulepreload" href="./_npm/isoformat@0.2.1/c68fbd73.js">
<link rel="modulepreload" href="./_npm/katex@0.16.11/c006fecc.js">
<link rel="modulepreload" href="./_npm/d3-array@3.2.4/e95f898e.js">
<link rel="modulepreload" href="./_npm/d3-axis@3.0.0/d44feff9.js">
<link rel="modulepreload" href="./_npm/d3-brush@3.0.0/5830b12a.js">
<link rel="modulepreload" href="./_npm/d3-chord@3.0.1/84d7b8e9.js">
<link rel="modulepreload" href="./_npm/d3-color@3.1.0/2c0cdfa2.js">
<link rel="modulepreload" href="./_npm/d3-contour@4.0.2/626bedc4.js">
<link rel="modulepreload" href="./_npm/d3-delaunay@6.0.4/00c41b5d.js">
<link rel="modulepreload" href="./_npm/d3-dispatch@3.0.1/b5f7cdc6.js">
<link rel="modulepreload" href="./_npm/d3-drag@3.0.0/b22c5864.js">
<link rel="modulepreload" href="./_npm/d3-dsv@3.0.1/407f7a1f.js">
<link rel="modulepreload" href="./_npm/d3-ease@3.0.1/6f15f633.js">
<link rel="modulepreload" href="./_npm/d3-fetch@3.0.1/ef1ec490.js">
<link rel="modulepreload" href="./_npm/d3-force@3.0.0/5e1ff060.js">
<link rel="modulepreload" href="./_npm/d3-format@3.1.0/5851d7ef.js">
<link rel="modulepreload" href="./_npm/d3-geo@3.1.1/dcd02767.js">
<link rel="modulepreload" href="./_npm/d3-hierarchy@3.1.2/f1db2593.js">
<link rel="modulepreload" href="./_npm/d3-interpolate@3.0.1/034b7bcb.js">
<link rel="modulepreload" href="./_npm/d3-path@3.1.0/4bb53638.js">
<link rel="modulepreload" href="./_npm/d3-polygon@3.0.1/bbafde58.js">
<link rel="modulepreload" href="./_npm/d3-quadtree@3.0.1/aa5b35a8.js">
<link rel="modulepreload" href="./_npm/d3-random@3.0.1/32c7fec2.js">
<link rel="modulepreload" href="./_npm/d3-scale@4.0.2/567840a0.js">
<link rel="modulepreload" href="./_npm/d3-scale-chromatic@3.1.0/cf9b720b.js">
<link rel="modulepreload" href="./_npm/d3-selection@3.0.0/5dcd62f4.js">
<link rel="modulepreload" href="./_npm/d3-shape@3.2.0/f8e03c56.js">
<link rel="modulepreload" href="./_npm/d3-time@3.1.0/5bc129e1.js">
<link rel="modulepreload" href="./_npm/d3-time-format@4.1.0/19c92b44.js">
<link rel="modulepreload" href="./_npm/d3-timer@3.0.1/f31b5398.js">
<link rel="modulepreload" href="./_npm/d3-transition@3.0.1/8debb4ba.js">
<link rel="modulepreload" href="./_npm/d3-zoom@3.0.0/4b0cc581.js">
<link rel="modulepreload" href="./_npm/interval-tree-1d@1.0.4/a62ae5ce.js">
<link rel="modulepreload" href="./_npm/acorn@8.12.1/9e2c2538.js">
<link rel="modulepreload" href="./_npm/apache-arrow@17.0.0/169cdc0a.js">
<link rel="modulepreload" href="./_npm/internmap@2.0.3/5eed35fd.js">
<link rel="modulepreload" href="./_npm/delaunator@5.0.1/e67acb27.js">
<link rel="modulepreload" href="./_npm/binary-search-bounds@2.0.5/1ee6c50d.js">
<link rel="modulepreload" href="./_npm/tslib@2.7.0/f0f7d58c.js">
<link rel="modulepreload" href="./_npm/flatbuffers@24.3.25/fd24637b.js">
<link rel="modulepreload" href="./_npm/robust-predicates@3.0.2/8ac9039b.js">
<link rel="icon" href="./_file/observable.1af93621.png" type="image/png" sizes="32x32">
<script type="module">

import {define} from "./_observablehq/client.7e44a896.js";

define({id: "f7ba7a53", outputs: ["SJS"], body: () => {
// JavaScript for sampling from a handful of discrete probability distributions
// From: https://github.com/jacobmenick/sampling

const SJS = (function(){

    // Utility functions
    function _sum(a, b) {
	return a + b;
    };
    function _fillArrayWithNumber(size, num) {
	// thanks be to stackOverflow... this is a beautiful one-liner
	return Array.apply(null, Array(size)).map(Number.prototype.valueOf, num);
    };
    function _rangeFunc(upper) {
	var i = 0, out = [];
	while (i < upper) out.push(i++);
	return out;
    };
    // Prototype function
    function _samplerFunction(size) {
	if (!Number.isInteger(size) || size < 0) {
	  throw new Error ("Number of samples must be a non-negative integer.");
	}
	if (!this.draw) {
	    throw new Error ("Distribution must specify a draw function.");
	}
	var result = [];
	while (size--) {
	    result.push(this.draw());
	}
	return result;
    };
    // Prototype for discrete distributions
    var _samplerPrototype = {
	sample: _samplerFunction
    };

    function Bernoulli(p) {

	var result = Object.create(_samplerPrototype);

	result.draw = function() {
	    return (Math.random() < p) ? 1 : 0;
	};

	result.toString = function() {
	    return "Bernoulli( " + p + " )";
	};

	return result;
    }

    function Binomial(n, p) {

	var result = Object.create(_samplerPrototype),
	bern = this.Bernoulli(p);
    
	result.draw = function() {
	    return bern.sample(n).reduce(_sum, 0); // less space efficient than adding a bunch of draws, but cleaner :)
	}

	result.toString = function() { 
	    return "Binom( " + 
		[n, p].join(", ") + 
		" )"; 
	}

	return result;
    }

    function Discrete(probs) { // probs should be an array of probabilities. (they get normalized automagically) //
	
	var result = Object.create(_samplerPrototype),
	k = probs.length;

	result.draw = function() {
	    var i, p;
	    for (i = 0; i < k; i++) {
		p = probs[i] / probs.slice(i).reduce(_sum, 0); // this is the (normalized) head of a slice of probs
		if (Bernoulli(p).draw()) return i;             // using the truthiness of a Bernoulli draw
	    }
	    return k - 1;
	};

	result.sampleNoReplace = function(size) {
	    if (size>probs.length) {
		throw new Error("Sampling without replacement, and the sample size exceeds vector size.")
	    }
	    var disc, index, sum, samp = [];
	    var currentProbs = probs;
	    var live = _rangeFunc(probs.length);
	    while (size--) {
		sum = currentProbs.reduce(_sum, 0);
		currentProbs = currentProbs.map(function(x) {return x/sum; });
		disc = this.Discrete(currentProbs);
		index = disc.draw();
		samp.push(live[index]);
		live.splice(index, 1);
		currentProbs.splice(index, 1);
		sum = currentProbs.reduce(_sum, 0);
		currentProbs = currentProbs.map(function(x) {return x/sum; });
	    }
	    currentProbs = probs;
	    live = _rangeFunc(probs.length);
	    return samp;
	}

	result.toString = function() {
	    return "Dicrete( [" + 
		probs.join(", ") + 
		"] )";
	};

	return result;
    }

    function Multinomial(n, probs) {

	var result = Object.create(_samplerPrototype),
	k = probs.length,
	disc = Discrete(probs);

	result.draw = function() {
	    var draw_result = _fillArrayWithNumber(k, 0),
	    i = n;
	    while (i--) {
		draw_result[disc.draw()] += 1;
	    }
	    return draw_result;
	};

	result.toString = function() {
	    return "Multinom( " + 
		n + 
		", [" + probs.join(", ") + 
		"] )";
	};

	return result;
    }

    function NegBinomial(r, p) {
	var result = Object.create(_samplerPrototype);

	result.draw = function() {
	    var draw_result = 0, failures = r;
	    while (failures) {
		Bernoulli(p).draw() ? draw_result++ : failures--;
	    }
	    return draw_result;
	};

	result.toString = function() {
	    return "NegBinomial( " +  r +
		", " + p + " )";
	};

	return result;
    }

    function Poisson(lambda) {
	var result = Object.create(_samplerPrototype);

	result.draw = function() {
	    var draw_result, L = Math.exp(- lambda), k = 0, p = 1;

	    do {
		k++;
		p = p * Math.random()
	    } while (p > L);
	    return k-1;
	}

	result.toString = function() {
	    return "Poisson( " + lambda + " )";
	}

	return result;
    }

    return {
	_fillArrayWithNumber: _fillArrayWithNumber, // REMOVE EVENTUALLY - this is just so the Array.prototype mod can work
	_rangeFunc: _rangeFunc,
	'Bernoulli': Bernoulli,
	Binomial: Binomial,
	Discrete: Discrete,
	Multinomial: Multinomial,
	NegBinomial: NegBinomial,
	Poisson: Poisson
    };
})();
return {SJS};
}});

define({id: "48070a84", inputs: ["localStorage"], outputs: ["SummaryTable","storedADSL","storedMasterData","storedAdslInputs","storedAdlbInputs"], body: async (localStorage) => {
const {SummaryTable} = await import("./_import/components/summaryTable.bd8e7950.js");

const storedADSL = JSON.parse(localStorage.getItem("ADSL"));
const storedMasterData = JSON.parse(localStorage.getItem("masterData"));
const storedAdslInputs = JSON.parse(localStorage.getItem("adslInputs"));
const storedAdlbInputs = JSON.parse(localStorage.getItem("adlbInputs"));
return {SummaryTable,storedADSL,storedMasterData,storedAdslInputs,storedAdlbInputs};
}});

define({id: "fc3d1856", inputs: ["view","Inputs","storedAdslInputs","html","d3"], outputs: ["FLG2_cutoff"], body: (view,Inputs,storedAdslInputs,html,d3) => {
const FLG2_cutoff = view(Inputs.range([storedAdslInputs.bmi1, storedAdslInputs.bmi2], {label: html`Marker FLG2 Cutoff`, value: d3.mean([storedAdslInputs.bmi1, storedAdslInputs.bmi2]), step: 1}));
return {FLG2_cutoff};
}});

define({id: "45cdaf97", mode: "inline", inputs: ["tex","display"], body: async (tex,display) => {
display(await(
tex` > `
))
}});

define({id: "c76bcdfc", mode: "inline", inputs: ["FLG2_cutoff","display"], body: async (FLG2_cutoff,display) => {
display(await(
FLG2_cutoff
))
}});

define({id: "b32a4a78", mode: "inline", inputs: ["storedADSL","FLG2_cutoff","display"], body: async (storedADSL,FLG2_cutoff,display) => {
display(await(
storedADSL.filter(d=>d.FLG1 === 'No').filter(d=>d.BMI > FLG2_cutoff).length
))
}});

define({id: "d791d065", mode: "inline", inputs: ["storedADSL","FLG2_cutoff","display"], body: async (storedADSL,FLG2_cutoff,display) => {
display(await(
storedADSL.filter(d=>d.FLG1 === 'Yes').filter(d=>d.BMI > FLG2_cutoff).length
))
}});

define({id: "22f14433", mode: "inline", inputs: ["storedADSL","FLG2_cutoff","display"], body: async (storedADSL,FLG2_cutoff,display) => {
display(await(
storedADSL.filter(d=>d.FLG1 === 'No').filter(d=>d.BMI > FLG2_cutoff).length + storedADSL.filter(d=>d.FLG1 === 'Yes').filter(d=>d.BMI > FLG2_cutoff).length
))
}});

define({id: "2947d3ce", mode: "inline", inputs: ["tex","display"], body: async (tex,display) => {
display(await(
tex` \leq `
))
}});

define({id: "c76bcdfc-1", mode: "inline", inputs: ["FLG2_cutoff","display"], body: async (FLG2_cutoff,display) => {
display(await(
FLG2_cutoff
))
}});

define({id: "0fec3de8", mode: "inline", inputs: ["storedADSL","FLG2_cutoff","display"], body: async (storedADSL,FLG2_cutoff,display) => {
display(await(
storedADSL.filter(d=>d.FLG1 === 'No').filter(d=>d.BMI <= FLG2_cutoff).length
))
}});

define({id: "9e29af2e", mode: "inline", inputs: ["storedADSL","FLG2_cutoff","display"], body: async (storedADSL,FLG2_cutoff,display) => {
display(await(
storedADSL.filter(d=>d.FLG1 === 'Yes').filter(d=>d.BMI <= FLG2_cutoff).length
))
}});

define({id: "b9ac865d", mode: "inline", inputs: ["storedADSL","FLG2_cutoff","display"], body: async (storedADSL,FLG2_cutoff,display) => {
display(await(
storedADSL.filter(d=>d.FLG1 === 'No').filter(d=>d.BMI <= FLG2_cutoff).length + storedADSL.filter(d=>d.FLG1 === 'Yes').filter(d=>d.BMI <= FLG2_cutoff).length
))
}});

define({id: "7222c8b9", mode: "inline", inputs: ["storedADSL","FLG2_cutoff","display"], body: async (storedADSL,FLG2_cutoff,display) => {
display(await(
storedADSL.filter(d=>d.FLG1 === 'No').filter(d=>d.BMI > FLG2_cutoff).length + storedADSL.filter(d=>d.FLG1 === 'No').filter(d=>d.BMI <= FLG2_cutoff).length
))
}});

define({id: "75421d74", mode: "inline", inputs: ["storedADSL","FLG2_cutoff","display"], body: async (storedADSL,FLG2_cutoff,display) => {
display(await(
storedADSL.filter(d=>d.FLG1 === 'Yes').filter(d=>d.BMI > FLG2_cutoff).length + storedADSL.filter(d=>d.FLG1 === 'Yes').filter(d=>d.BMI <= FLG2_cutoff).length
))
}});

define({id: "76b18840", mode: "inline", inputs: ["storedADSL","display"], body: async (storedADSL,display) => {
display(await(
[... new Set(storedADSL.map(d=>d.USUBJID))].length
))
}});

define({id: "0f4e6142", inputs: ["view","Inputs","FLG2_cutoff","htl"], outputs: ["Flags"], body: (view,Inputs,FLG2_cutoff,htl) => {
const Flags = view(
    Inputs.select(
    [
    `FLG1=No & BMI > ${FLG2_cutoff}`,
    `FLG1=Yes & BMI > ${FLG2_cutoff}`,
    `FLG1=No & BMI ≤ ${FLG2_cutoff}`,
    `FLG1=Yes & BMI ≤ ${FLG2_cutoff}`,
    ], 
    {multiple: true, label: htl.html`Subgroup Selection <br><br> (<code>CTRL+Click</code> for Multiple Selection)`,value: [`FLG1=No & BMI > ${FLG2_cutoff}`,]}
    )
)

return {Flags};
}});

define({id: "72cc7b57", inputs: ["Plot","FLG2_cutoff","display"], body: async (Plot,FLG2_cutoff,display) => {
display(await(
Plot.legend({
  color:{
    type: 'ordinal',
    domain:   ['ITT (Reference)', 
                `FLG1=No & BMI > ${FLG2_cutoff}`,
                `FLG1=Yes & BMI > ${FLG2_cutoff}`,
                `FLG1=No & BMI ≤ ${FLG2_cutoff}`,
                `FLG1=Yes & BMI ≤ ${FLG2_cutoff}`,
              ], 
    range: ['#aaa', '#FD841F', '#3E6D9C', '#379237', '#E14D2A',   ]
  }
})

))
}});

define({id: "a5c7d171", mode: "inline", inputs: ["month","display"], body: async (month,display) => {
display(await(
month
))
}});

define({id: "e77c52b2", inputs: ["view","Inputs"], outputs: ["month"], body: (view,Inputs) => {
const month = view(Inputs.range([0, 24], {label: "", step: 1, value: 18}))
return {month};
}});

define({id: "1b77f44b", inputs: ["htl","plot2","plot1","display"], outputs: ["plot_comb"], body: (htl,plot2,plot1,display) => {
const plot_comb = htl.html`
<div style="overflow-x: auto">
  <div style="display: flex; flex-direction: column;">
    <div style="display: flex; position: relative; top: 0px;">
      ${[plot2(), plot1()]}
    </div>
  </div>
</div
`

display(plot_comb)
return {plot_comb};
}});

define({id: "01ba4719", body: () => {

}});

define({id: "b32a9271", inputs: ["joinedData","FLG2_cutoff","Plot","Flags","month","ADTTE","obj","d3"], outputs: ["plot1","plot2","getMedian","pick","dict","median_hr"], body: (joinedData,FLG2_cutoff,Plot,Flags,month,ADTTE,obj,d3) => {
function plot1() {

  const data = joinedData.map(d => ({
    ...d, 
    'flag': d.FLG1 === 'No' & d.BMI > FLG2_cutoff 
            ?  `FLG1=No & BMI > ${FLG2_cutoff}`
            :  d.FLG1 === 'Yes' & d.BMI > FLG2_cutoff 
            ?  `FLG1=Yes & BMI > ${FLG2_cutoff}`
            :  d.FLG1 === 'No' & d.BMI <= FLG2_cutoff 
            ?  `FLG1=No & BMI ≤ ${FLG2_cutoff}`
            :  d.FLG1 === 'Yes' & d.BMI <= FLG2_cutoff 
            ?  `FLG1=Yes & BMI ≤ ${FLG2_cutoff}` : 'ALL',
    })        
   )

  const minAVALID = data.sort((a,b)=>a.AVAL - b.AVAL)[0].USUBJID
  
  return Plot.plot({
        marginLeft: 10,
        marginRight: 10,
        height:data.length * 10,
        width:400,
        // color: {
        //   legend:true,
        // },
        style: {
          // background: '#fafafa',
        },
        y: {
          label: null,
          tickSize: 0,
          margin: 10,
          axis: null,
        },
        x:{
          label: 'Month →',
          grid: true,
          domain: [0,24],
          ticks: 8,
          // axis: 'top',
        },

        marks: [
          Plot.ruleY(data, 
                     {x: "AVAL", y: "USUBJID", 
                      // stroke: d=>d.AVAL <= month ? 'orange' : 'black',
                      stroke: d => Flags.includes(`FLG1=Yes & BMI ≤ ${FLG2_cutoff}`) & d.FLG1 === 'Yes' & d.BMI <= FLG2_cutoff 
                            ? '#E14D2A'
                            :  Flags.includes(`FLG1=No & BMI > ${FLG2_cutoff}`) & d.FLG1 === 'No' & d.BMI > FLG2_cutoff 
                            ?  '#FD841F'
                            :  Flags.includes(`FLG1=Yes & BMI > ${FLG2_cutoff}`) & d.FLG1 === 'Yes' & d.BMI > FLG2_cutoff 
                            ? '#3E6D9C'
                            :  Flags.includes(`FLG1=No & BMI ≤ ${FLG2_cutoff}`) & d.FLG1 === 'No' & d.BMI <= FLG2_cutoff 
                            ?  '#379237' : '#aaa',
                      // stroke: Flags.includes('MARKFL1B=1 & MARKFL2=1') ? '#E14D2A' : 'black', 
                      strokeWidth: 3,
                      strokeDasharray: d=>d.CNSR == 1 ? (3,3) : (0,0),
                     sort: {y: 'x'}}
                    ),
          Plot.dot(data.filter(d=>d.CNSR !== 1), 
                   {
                     x: "AVAL", y: "USUBJID", 
                     // fill: d=> d.CNSR ? 'white': d.AVAL <= month ? 'orange' : 'black', 
                     // stroke: d=>d.AVAL <= month ? 'orange' : 'black',         
                      fill: d => Flags.includes(`FLG1=Yes & BMI ≤ ${FLG2_cutoff}`) & d.FLG1 === 'Yes' & d.BMI <= FLG2_cutoff 
                            ? '#E14D2A'
                            :  Flags.includes(`FLG1=No & BMI > ${FLG2_cutoff}`) & d.FLG1 === 'No' & d.BMI > FLG2_cutoff 
                            ?  '#FD841F'
                            :  Flags.includes(`FLG1=Yes & BMI > ${FLG2_cutoff}`) & d.FLG1 === 'Yes' & d.BMI > FLG2_cutoff 
                            ? '#3E6D9C'
                            :  Flags.includes(`FLG1=No & BMI ≤ ${FLG2_cutoff}`) & d.FLG1 === 'No' & d.BMI <= FLG2_cutoff 
                            ?  '#379237' : '#aaa',
                     // fill: d => d.CNSR ? 'white' : null,
                     // stroke: d => d.CNSR ? null : d.flag,
                     r: 3}
                  ),
          Plot.text(data, 
                   {
                     x: "AVAL", y: "USUBJID",                      
                     text: d=> d.CNSR === 1 ? "X" : '', 
                     fill: 'black',
                     fontWeight: 'bold',
                     fontSize: 10}          
                  ),
          Plot.text([[19, minAVALID]], 
                   {                 
                     text: ['X Censoring'], 
                     fill: '#666',
                     fontWeight: 'bold',
                     textAnchor: 'start',
                     fontSize: 12}          
                  ),
          Plot.text([[19, minAVALID]], 
                   {                 
                     text: ['● Event'], 
                     dy: 10,
                     fill: '#666',
                     fontWeight: 'bold',
                     textAnchor: "start",
                     fontSize: 12}          
                  ),
          // Plot.ruleY([]),
          Plot.ruleX([0, 24]),
          Plot.ruleX([month], {stroke: '#333', strokeDasharray: (3,3)}),
        ]
})
}

function plot2() {
    // const ref = getMedian(obj.groupedData)
    // let r = [ref]
    
    // Object.values(pick(dict, Flags))
    // .map(d => {
    //   r.push(getMedian(obj[d]))
    // })
  
    let r1 = 'Median: ' + median_hr().median.join(' vs ')

    // let r2 = []
    // r.slice(1)    
    //   .map(d => {
    //   r2.push(ref === 'NA' | d === 'NA' ? 'NA' : (ref / d).toFixed(2))
    // })

    let r3 = 'Hazard ratio: ' + median_hr().HR.join(' | ')

  return Plot.plot({
              marginLeft: 30,
              marginRight: 20,
              height:ADTTE.length * 10,
              width:700,
              style: {
                // background: '#fafafa',
              },
              y: {
                label: '↑ Probability of event free beyond time T',
                // tickSize: 0,
                margin: 10,
                domain: [0,1],
              },
              x:{
                label: 'Month →',
                grid: true,
                domain: [0,24],
                ticks: 8,
                // axis: 'top',
              },
              marks: [
            
                // Plot.text([[1, 0.2]], 
                //           {text: [r1],
                //            fontSize: 16,
                //            textAnchor: "start",
                //            fontWeight: 'bold',
                //            fill: '#777'
                //           }),

                // Plot.text([[1, 0.25]], 
                //           {text: [r3],
                //            fontSize: 16,
                //            textAnchor: "start",
                //            fontWeight: 'bold',
                //            fill: '#777'
                //           }),
            
               
                
                Plot.ruleX([month], {stroke: '#333', strokeDasharray: (3,3)}),
                Plot.ruleY([0.5], {stroke: '#333', strokeDasharray: (3,3)}),
                
                Plot.line(obj.plotDataForLine, {x:'x', y:'y', stroke: '#aaa' }),
                                                 // stroke: Flags.includes('ALL') ? '#333' : null }),
                Plot.text(obj.plotDataForTicks, {x:'x', y:'y', text: 'text', fontSize: 24, dy:-1, fill: 'blue',}),
                                            // fill: Flags.includes('ALL') ? 'blue' : null }),
                Plot.line(obj.plotDataForLine_11_21, {x:'x', y:'y', 
                                                 stroke: Flags.includes(`FLG1=Yes & BMI ≤ ${FLG2_cutoff}`) ? '#E14D2A' : null }),
                Plot.text(obj.plotDataForTicks_11_21, {x:'x', y:'y', text: 'text', fontSize: 24, dy:-1,
                                                      fill: Flags.includes(`FLG1=Yes & BMI ≤ ${FLG2_cutoff}`) ? 'blue' : null }),
                Plot.line(obj.plotDataForLine_10_20, {x:'x', y:'y',
                                                     stroke: Flags.includes(`FLG1=No & BMI > ${FLG2_cutoff}`) ? '#FD841F' : null }),
                Plot.text(obj.plotDataForTicks_10_20, {x:'x', y:'y', text: 'text', fontSize: 24, dy:-1,
                                                      fill: Flags.includes(`FLG1=No & BMI > ${FLG2_cutoff}`) ? 'blue' : null }),
                Plot.line(obj.plotDataForLine_11_20, {x:'x', y:'y',
                                                     stroke: Flags.includes(`FLG1=Yes & BMI > ${FLG2_cutoff}`) ? '#3E6D9C' : null }),
                Plot.text(obj.plotDataForTicks_11_20, {x:'x', y:'y', text: 'text', fontSize: 24, dy:-1,
                                                      fill: Flags.includes(`FLG1=Yes & BMI > ${FLG2_cutoff}`) ? 'blue' : null }),
                Plot.line(obj.plotDataForLine_10_21, {x:'x', y:'y',
                                                     stroke: Flags.includes(`FLG1=No & BMI ≤ ${FLG2_cutoff}`) ? '#379237' : null }),
                Plot.text(obj.plotDataForTicks_10_21, {x:'x', y:'y', text: 'text', fontSize: 24, dy:-1,
                                                      fill: Flags.includes(`FLG1=No & BMI ≤ ${FLG2_cutoff}`) ? 'blue' : null }),
              ]
            })
}

function getMedian(data) {
  const dataFiltered = data
                      .slice()
                      .filter(d => d.t <= month)

  const belowMedian = dataFiltered.filter(d => d.prob < 0.5)

  let median = 0
  let hrMedian = 0

  median = belowMedian.length === 0 ? 'NA' : belowMedian.sort((a,b)=>a.t-b.t)[0].t

  hrMedian = belowMedian.length === 0 ? dataFiltered.length === 0 ? 1 : d3.max(dataFiltered, d=>d.t) : belowMedian.sort((a,b)=>a.t-b.t)[0].t
  
  return {'median': median, 'hrMedian': hrMedian}
}

function pick(obj, keys) {
  return Object.keys(obj).filter(k => keys.includes(k)).reduce((res, k) => Object.assign(res, {[k]: obj[k]}), {});
} 

function dict() {
  const flagOptions =   [
   `FLG1=No & BMI > ${FLG2_cutoff}`,
   `FLG1=Yes & BMI > ${FLG2_cutoff}`,
   `FLG1=No & BMI ≤ ${FLG2_cutoff}`,
   `FLG1=Yes & BMI ≤ ${FLG2_cutoff}`,
  ]

  const b = [
    'groupedData_10_20',
    'groupedData_11_20',
    'groupedData_10_21',
    'groupedData_11_21',
  ]

  let r ={}
  const c = flagOptions.map((d,i) => {
    r[d] = b[i]
  })

  return r
}


function median_hr() {
  const ref = getMedian(obj.groupedData).median
  const refhr = getMedian(obj.groupedData).hrMedian
  let r = [ref]
  let rhr = [refhr]

  Object.values(pick(dict(), Flags))
    .map(d => {
      r.push(getMedian(obj[d]).median)
    })

    Object.values(pick(dict(), Flags))
    .map(d => {
      rhr.push(getMedian(obj[d]).hrMedian)
    })


  let r1 = 'Median: ' + r.join(' vs ')

  let r2 = []
  r.slice(1)    
    .map(d => {
      r2.push(ref === 'NA' | d === 'NA' ? 'NA' : (ref / d).toFixed(2))
    })

  let r2hr = []
  rhr.slice(1)    
    .map(d => {
      r2hr.push( (refhr / d).toFixed(2))
    })


  let r3 = 'Hazard ratio: ' + r2.join(' | ')

  return {'median': r, 'HR': r2hr }
}

return {plot1,plot2,getMedian,pick,dict,median_hr};
}});

define({id: "413bb80d", inputs: ["d3","month","showAllNumbers","ADTTE","FLG2_cutoff","obj","Flags"], outputs: ["table2"], body: (d3,month,showAllNumbers,ADTTE,FLG2_cutoff,obj,Flags) => {
function table2() {
  const table = d3.create("table").attr('id', 'table2')

  const tbody = table.append("tbody");

  tbody.append("tr")
       .data([['Month', ...d3.range(0,month+1)]])
       .join("tr")
       .selectAll("td")
       .data(row => row)
       .join("td")
       .text(d => d)
       .style("text-align", "center")

 
  tbody.append("tr")
       .data([['ITT (Reference)', ...showAllNumbers(ADTTE)].filter((d,i) => i-1 <= month)])
       .join("tr")
       .selectAll("td")
       .data(row => row)
       .join("td")
       .text(d => d)
       .style("text-align", "center")
       .style('color', '#aaa')
       
    tbody.append("tr")
       .data([[`FLG1=No & BMI > ${FLG2_cutoff}`, ...showAllNumbers(obj.data_10_20)].filter((d,i) => i-1 <= month)])
       .join("tr")
       .selectAll("td")
       .data(row => row)
       .join("td")
       .text(d => d)
       .style("text-align", "center")
      .style('display', Flags.includes(`FLG1=No & BMI > ${FLG2_cutoff}`) ? true : 'none')
      .style('color', '#FD841F')

    tbody.append("tr")
       .data([[`FLG1=Yes & BMI > ${FLG2_cutoff}`, ...showAllNumbers(obj.data_11_20)].filter((d,i) => i-1 <= month)])
       .join("tr")
       .selectAll("td")
       .data(row => row)
       .join("td")
       .text(d => d)
       .style("text-align", "center")
      .style('display', Flags.includes(`FLG1=Yes & BMI > ${FLG2_cutoff}`) ? true : 'none')
      .style('color', '#3E6D9C')

    tbody.append("tr")
       .data([[`FLG1=No & BMI ≤ ${FLG2_cutoff}`, ...showAllNumbers(obj.data_10_21)].filter((d,i) => i-1 <= month)])
       .join("tr")
       .selectAll("td")
       .data(row => row)
       .join("td")
       .text(d => d)
       .style("text-align", "center")
      .style('display', Flags.includes(`FLG1=No & BMI ≤ ${FLG2_cutoff}`) ? true : 'none')
      .style('color', '#379237')

    tbody.append("tr")
       .data([[`FLG1=Yes & BMI ≤ ${FLG2_cutoff}`, ...showAllNumbers(obj.data_11_21)].filter((d,i) => i-1 <= month)])
       .join("tr")
       .selectAll("td")
       .data(row => row)
       .join("td")
       .text(d => d)
       .style("text-align", "center")
      .style('display', Flags.includes(`FLG1=Yes & BMI ≤ ${FLG2_cutoff}`) ? true : 'none')
      .style('color', '#E14D2A')

  return table.node();
}

return {table2};
}});

define({id: "d68148d1", inputs: ["display","table2"], body: (display,table2) => {
display(table2())
}});

define({id: "ae61d176", inputs: ["d3","aq","ADTTE","storedADSL","ADRS","month","FLG2_cutoff"], outputs: ["showAllNumbers","joinedData","joinedDataFiltered","adtteFiltered","funGroupedData","funPlotDataForLine","funPlotDataForTicks","genObj"], body: (d3,aq,ADTTE,storedADSL,ADRS,month,FLG2_cutoff) => {
function showAllNumbers(ADTTE) {
  let res = [ADTTE.length]
  d3.range(1, 25).map(month => {
      const c0 = ADTTE.slice().filter(d => d.AVAL <= month).filter(d => d.CNSR == 0)
      const c1 = ADTTE.slice().filter(d => d.AVAL <= month).filter(d => d.CNSR == 1)
      const c0N = c0.length
      const c1N = c1.length
      const sn = (ADTTE.length - c0N -c1N) 
      res.push(sn)
  })

  return res
}

const joinedData = aq.from(ADTTE)
    .join(aq.from(storedADSL), ['USUBJID', 'USUBJID'])
    .join(aq.from(ADRS), ['USUBJID', 'USUBJID'])
    .objects()

const joinedDataFiltered = joinedData.filter(d => d.AVAL <= month)
const adtteFiltered = ADTTE.filter(d => d.AVAL <= month)

function funGroupedData(ADTTE, adtteFiltered) {
  const eventTimes = [... new Set(
    ADTTE
      .slice().sort((a,b) => d3.ascending(a.AVAL, b.AVAL))
      .filter(d => d['CNSR'] === 0)
      .map(d => d.AVAL)
  )]

  function d(t){
    // the number of events that happened at time t 
     return adtteFiltered.filter(d => d.AVAL === t).length
  }

  function n(t){
    // the number of individuals known to have survived up to time t
    // (not dead and not censored)
    return ADTTE.filter(d => d.AVAL >= t).length
  }

  function S(t){
    // Survival function at time t
    let product = 1;
    for(const time of eventTimes.filter(time => time <= t)){
      product = product * (1 - d(time) / n(time));
    }
    return product;
  }
  
  const res = eventTimes.map(time => new Object({"t" : time, "prob" : S(time)})) 

  return res.length === 0 ? [{'t':0, 'prob': 1}] : res
}


function funPlotDataForLine(groupedData) {

  /* Begin the line */

  const plotData = [
    {
      x : 0,
      y : 1,
    },
    {
      x : groupedData[0]['t'],
      y : 1,
    }
  ];
  
  for (let i = 0; i < groupedData.length - 1; i++){
      plotData.push(
        {
          x : groupedData[i]['t'], 
          y : groupedData[i]['prob']
        },
        {
          x : groupedData[i + 1]['t'], 
          y : groupedData[i]['prob']
        }
      )
  }

   plotData.push(
        {
          x : groupedData[groupedData.length - 1]['t'], 
          y : groupedData[groupedData.length - 1]['prob']
        }
      )

  const dataTimes = adtteFiltered.map(datum => datum.AVAL).sort(d3.ascending);

  const finalT = dataTimes[dataTimes.length - 1];
  const timesFromGroupedData = plotData.map(datum => datum.x);
  
  const finalY = plotData[plotData.length - 1]['y'];
  
  if(!timesFromGroupedData.includes(finalT)){
    plotData.push({x : finalT, y : finalY})
  }
  
  // return plotData.slice().sort((a,b) => d3.ascending(a.x, b.x) || d3.ascending(b.y, a.y));
  return plotData
}

function funPlotDataForTicks(groupedData, adtteFiltered) {
  const censoredEventTimes = adtteFiltered.slice().sort((a,b) => d3.ascending(a.AVAL, b.AVAL))
                                  .filter(d => d.CNSR === 1).map(d => d.AVAL)
  const plotData = [];

  for (const censoredEventTime of censoredEventTimes){
    // let y = groupedData[0]['prob'];
    let y = 1
    
    // for (let i = 1; i < groupedData.length; i ++){
    for (let i = 0; i < groupedData.length; i ++){
      if(groupedData[i]['t'] < censoredEventTime){
          y = groupedData[i]['prob']
        }        
    }

    plotData.push({"x" : censoredEventTime, "y": y, "text": "+"})    
  }
  
  return  plotData;
}



function genObj() {
  const data_10_20 = joinedData.filter(d => d.FLG1 === 'No' & d.BMI > FLG2_cutoff)
  const data_11_20 = joinedData.filter(d => d.FLG1 === 'Yes' & d.BMI > FLG2_cutoff)
  const data_10_21 = joinedData.filter(d => d.FLG1 === 'No' & d.BMI <= FLG2_cutoff)
  const data_11_21 = joinedData.filter(d => d.FLG1 === 'Yes' & d.BMI <= FLG2_cutoff)

  const data_10_20Filtered = joinedDataFiltered.filter(d => d.FLG1 === 'No' & d.BMI > FLG2_cutoff)
  const data_11_20Filtered = joinedDataFiltered.filter(d => d.FLG1 === 'Yes' & d.BMI > FLG2_cutoff)
  const data_10_21Filtered = joinedDataFiltered.filter(d => d.FLG1 === 'No' & d.BMI <= FLG2_cutoff)
  const data_11_21Filtered = joinedDataFiltered.filter(d => d.FLG1 === 'Yes' & d.BMI <= FLG2_cutoff)
  
  const groupedData = funGroupedData(ADTTE, adtteFiltered)
  const groupedData_10_20 = funGroupedData(data_10_20, data_10_20Filtered)
  const groupedData_11_20 = funGroupedData(data_11_20, data_11_20Filtered)
  const groupedData_10_21 = funGroupedData(data_10_21, data_10_21Filtered)
  const groupedData_11_21 = funGroupedData(data_11_21, data_11_21Filtered)

  const plotDataForLine = funPlotDataForLine(groupedData)
  const plotDataForLine_10_20 = funPlotDataForLine(groupedData_10_20)
  const plotDataForLine_11_20 = funPlotDataForLine(groupedData_11_20)
  const plotDataForLine_10_21 = funPlotDataForLine(groupedData_10_21)
  const plotDataForLine_11_21 = funPlotDataForLine(groupedData_11_21)

  const plotDataForTicks = funPlotDataForTicks(groupedData, adtteFiltered)
  const plotDataForTicks_10_20 = funPlotDataForTicks(groupedData_10_20, data_10_20Filtered)
  const plotDataForTicks_11_20 = funPlotDataForTicks(groupedData_11_20, data_11_20Filtered)
  const plotDataForTicks_10_21 = funPlotDataForTicks(groupedData_10_21, data_10_21Filtered)
  const plotDataForTicks_11_21 = funPlotDataForTicks(groupedData_11_21, data_11_21Filtered)

  return {
          'data_10_20': data_10_20,
          'data_11_20': data_11_20,
          'data_10_21': data_10_21,
          'data_11_21': data_11_21,

          'data_10_20Filtered': data_10_20Filtered,
          'data_11_20Filtered': data_11_20Filtered,
          'data_10_21Filtered': data_10_21Filtered,
          'data_11_21Filtered': data_11_21Filtered,
    
          'groupedData': groupedData,
          'groupedData_10_20': groupedData_10_20,
          'groupedData_11_20': groupedData_11_20,
          'groupedData_10_21': groupedData_10_21,
          'groupedData_11_21': groupedData_11_21,

          'plotDataForLine': plotDataForLine,
          'plotDataForLine_10_20': plotDataForLine_10_20,
          'plotDataForLine_11_20': plotDataForLine_11_20,
          'plotDataForLine_10_21': plotDataForLine_10_21,
          'plotDataForLine_11_21': plotDataForLine_11_21,

          'plotDataForTicks': plotDataForTicks,
          'plotDataForTicks_10_20': plotDataForTicks_10_20,
          'plotDataForTicks_11_20': plotDataForTicks_11_20,
          'plotDataForTicks_10_21': plotDataForTicks_10_21,
          'plotDataForTicks_11_21': plotDataForTicks_11_21,
         }
}

return {showAllNumbers,joinedData,joinedDataFiltered,adtteFiltered,funGroupedData,funPlotDataForLine,funPlotDataForTicks,genObj};
}});

define({id: "fb4f551b", inputs: ["genObj"], outputs: ["obj"], body: (genObj) => {
const obj = genObj()


return {obj};
}});

define({id: "04ab8565", inputs: ["d3","FLG2_cutoff","median_hr","Flags","display"], outputs: ["table4"], body: (d3,FLG2_cutoff,median_hr,Flags,display) => {
function table4() {
  const table = d3.create("table").attr('id', 'table4')
  const tbody = table.append("tbody");

  tbody.append("tr")
       .data([['', 'ITT (Reference)',
                `FLG1=No & BMI > ${FLG2_cutoff}`,
                `FLG1=Yes & BMI > ${FLG2_cutoff}`,
                `FLG1=No & BMI ≤ ${FLG2_cutoff}`,
                `FLG1=Yes & BMI ≤ ${FLG2_cutoff}`,
            ]])
       .join("tr")
       .selectAll("th")
       .data(row => row)
       .join("th")
       .text(d => d)
       .style("text-align", "center")
       .attr('class', (d,i) => 'hc'+i)
      .style('color', '#aaa')
  
  tbody.append("tr")
       .data([['Median', 
                ...median_hr().median
              ]]
            )
       .join("tr")
       .selectAll("td")
       .data(row => row)
       .join("td")
       .text(d => d)
       .style("text-align", "center")
      .attr('class', (d,i) => 'cc'+i)
       

    tbody.append("tr")
       .data([['Hazard Ratio', '-', 
                ...median_hr().HR
              ]]
            )
       .join("tr")
       .selectAll("td")
       .data(row => row)
       .join("td")
       .text(d => d)
       .style("text-align", "center")
       .attr('class', (d,i) => 'cc'+i)

    tbody.selectAll('.hc2')
      .style('display', Flags.includes(`FLG1=Yes & BMI ≤ ${FLG2_cutoff}`) ? true : 'none')
      .style('color', '#E14D2A')
    tbody.selectAll('.hc3')
      .style('display', Flags.includes(`FLG1=No & BMI > ${FLG2_cutoff}`,) ? true : 'none')
      .style('color', '#FD841F')
    tbody.selectAll('.hc4')
      .style('display', Flags.includes(`FLG1=Yes & BMI > ${FLG2_cutoff}`) ? true : 'none')
      .style('color', '#3E6D9C')
    tbody.selectAll('.hc5')
      .style('display', Flags.includes(`FLG1=No & BMI ≤ ${FLG2_cutoff}`) ? true : 'none')
      .style('color', '#379237')

    

  return table.node();
}

display(table4())
return {table4};
}});

define({id: "ad6ae6f7", inputs: ["storedAdslInputs","ADTTE","obj","month","d3","FLG2_cutoff","Flags"], outputs: ["showNumbers","objNumbers","table3"], body: (storedAdslInputs,ADTTE,obj,month,d3,FLG2_cutoff,Flags) => {
function showNumbers(ADTTE, data_11_21, data_10_20, data_11_20, data_10_21, month) {
  const c0 = ADTTE.slice().filter(d => d.AVAL <= month).filter(d => d.CNSR == 0)
  const c1 = ADTTE.slice().filter(d => d.AVAL <= month).filter(d => d.CNSR == 1)
  const c0N = c0.length
  const c1N = c1.length
  const sn = (storedAdslInputs.enrollment - c0N -c1N) 
  const st = ((storedAdslInputs.enrollment - c0N -c1N) / (storedAdslInputs.enrollment - c1N)).toFixed(3)

  const enrollment_11_21 = data_11_21.length
  const c0_11_21 = data_11_21.slice().filter(d => d.AVAL <= month).filter(d => d.CNSR == 0)
  const c1_11_21 = data_11_21.slice().filter(d => d.AVAL <= month).filter(d => d.CNSR == 1)
  const c0N_11_21 = c0_11_21.length
  const c1N_11_21 = c1_11_21.length
  const sn_11_21 = (enrollment_11_21 - c0N_11_21 -c1N_11_21) 
  const st_11_21 = ((enrollment_11_21 - c0N_11_21 -c1N_11_21) / (enrollment_11_21 - c1N_11_21)).toFixed(3)

  const enrollment_10_20 = data_10_20.length
  const c0_10_20 = data_10_20.slice().filter(d => d.AVAL <= month).filter(d => d.CNSR == 0)
  const c1_10_20 = data_10_20.slice().filter(d => d.AVAL <= month).filter(d => d.CNSR == 1)
  const c0N_10_20 = c0_10_20.length
  const c1N_10_20 = c1_10_20.length
  const sn_10_20 = (enrollment_10_20 - c0N_10_20 -c1N_10_20) 
  const st_10_20 = ((enrollment_10_20 - c0N_10_20 -c1N_10_20) / (enrollment_10_20 - c1N_10_20)).toFixed(3)

  const enrollment_11_20 = data_11_20.length
  const c0_11_20 = data_11_20.slice().filter(d => d.AVAL <= month).filter(d => d.CNSR == 0)
  const c1_11_20 = data_11_20.slice().filter(d => d.AVAL <= month).filter(d => d.CNSR == 1)
  const c0N_11_20 = c0_11_20.length
  const c1N_11_20 = c1_11_20.length
  const sn_11_20 = (enrollment_11_20 - c0N_11_20 -c1N_11_20) 
  const st_11_20 = ((enrollment_11_20 - c0N_11_20 -c1N_11_20) / (enrollment_11_20 - c1N_11_20)).toFixed(3)

  const enrollment_10_21 = data_10_21.length
  const c0_10_21 = data_10_21.slice().filter(d => d.AVAL <= month).filter(d => d.CNSR == 0)
  const c1_10_21 = data_10_21.slice().filter(d => d.AVAL <= month).filter(d => d.CNSR == 1)
  const c0N_10_21 = c0_10_21.length
  const c1N_10_21 = c1_10_21.length
  const sn_10_21 = (enrollment_10_21 - c0N_10_21 -c1N_10_21) 
  const st_10_21 = ((enrollment_10_21 - c0N_10_21 -c1N_10_21) / (enrollment_10_21 - c1N_10_21)).toFixed(3)

  return {
          'c0' : c0, 'c1': c1, 'c0N' : c0N, 'c1N': c1N, 'st' : st, 'sn': sn,
          'enrollment_11_21':enrollment_11_21, 'c0_11_21' : c0_11_21, 'c1_11_21': c1_11_21, 'c0N_11_21' : c0N_11_21, 'c1N_11_21': c1N_11_21, 'st_11_21' : st_11_21, 'sn_11_21' : sn_11_21,
          'enrollment_10_20':enrollment_10_20, 'c0_10_20' : c0_10_20, 'c1_10_20': c1_10_20, 'c0N_10_20' : c0N_10_20, 'c1N_10_20': c1N_10_20, 'st_10_20' : st_10_20, 'sn_10_20' : sn_10_20,
          'enrollment_11_20':enrollment_11_20, 'c0_11_20' : c0_11_20, 'c1_11_20': c1_11_20, 'c0N_11_20' : c0N_11_20, 'c1N_11_20': c1N_11_20, 'st_11_20' : st_11_20, 'sn_11_20' : sn_11_20,
          'enrollment_10_21':enrollment_10_21, 'c0_10_21' : c0_10_21, 'c1_10_21': c1_10_21, 'c0N_10_21' : c0N_10_21, 'c1N_10_21': c1N_10_21, 'st_10_21' : st_10_21, 'sn_10_21' : sn_10_21,
        }
}

const objNumbers = showNumbers(ADTTE, obj.data_11_21, obj.data_10_20, obj.data_11_20, obj.data_10_21, month)

function table3() {
  const table = d3.create("table").attr('id', 'table3')
  const tbody = table.append("tbody");

  tbody.append("tr")
       .data([['', 'Number of Events', 'Event Subjects', 'Number of Censored', 'Censored Subjects']])
       .join("tr")
       .selectAll("th")
       .data(row => row)
       .join("th")
       .text(d => d)
       .style("text-align", "center")
  
  tbody.append("tr")
       .data([['ITT (Reference)', 
               objNumbers.c0N, 
               objNumbers.c0.map(d => d.USUBJID.replace('Subject_', '')).join(', '),
               objNumbers.c1N, 
               objNumbers.c1.map(d => d.USUBJID.replace('Subject_', '')).join(', '),
              ]]
            )
       .join("tr")
       .selectAll("td")
       .data(row => row)
       .join("td")
       .text(d => d)
       .style("text-align", "center")
      .style('color', '#aaa')
       

    tbody.append("tr")
       .data([[`FLG1=Yes & BMI ≤ ${FLG2_cutoff}`, 
               objNumbers.c0N_11_21, 
               objNumbers.c0_11_21.map(d => d.USUBJID.replace('Subject_', '')).join(', '),
               objNumbers.c1N_11_21, 
               objNumbers.c1_11_21.map(d => d.USUBJID.replace('Subject_', '')).join(', '),
              ]]
            )
       .join("tr")
       .selectAll("td")
       .data(row => row)
       .join("td")
       .text(d => d)
       .style("text-align", "center")
      .style('display', Flags.includes(`FLG1=Yes & BMI ≤ ${FLG2_cutoff}`) ? true : 'none')
      .style('color', '#E14D2A')

    tbody.append("tr")
       .data([[`FLG1=No & BMI > ${FLG2_cutoff}`, 
               objNumbers.c0N_10_20, 
               objNumbers.c0_10_20.map(d => d.USUBJID.replace('Subject_', '')).join(', '),
               objNumbers.c1N_10_20, 
               objNumbers.c1_10_20.map(d => d.USUBJID.replace('Subject_', '')).join(', '),
              ]]
            )
       .join("tr")
       .selectAll("td")
       .data(row => row)
       .join("td")
       .text(d => d)
       .style("text-align", "center")
      .style('display', Flags.includes(`FLG1=No & BMI > ${FLG2_cutoff}`) ? true : 'none')
      .style('color', '#FD841F')

    tbody.append("tr")
       .data([[`FLG1=Yes & BMI > ${FLG2_cutoff}`, 
               objNumbers.c0N_11_20, 
               objNumbers.c0_11_20.map(d => d.USUBJID.replace('Subject_', '')).join(', '),
               objNumbers.c1N_11_20, 
               objNumbers.c1_11_20.map(d => d.USUBJID.replace('Subject_', '')).join(', '),
              ]]
            )
       .join("tr")
       .selectAll("td")
       .data(row => row)
       .join("td")
       .text(d => d)
       .style("text-align", "center")
      .style('display', Flags.includes(`FLG1=Yes & BMI > ${FLG2_cutoff}`) ? true : 'none')
      .style('color', '#3E6D9C')

    tbody.append("tr")
       .data([[`FLG1=No & BMI ≤ ${FLG2_cutoff}`, 
               objNumbers.c0N_10_21, 
               objNumbers.c0_10_21.map(d => d.USUBJID.replace('Subject_', '')).join(', '),
               objNumbers.c1N_10_21, 
               objNumbers.c1_10_21.map(d => d.USUBJID.replace('Subject_', '')).join(', '),
              ]]
            )
       .join("tr")
       .selectAll("td")
       .data(row => row)
       .join("td")
       .text(d => d)
       .style("text-align", "center")
      .style('display', Flags.includes(`FLG1=No & BMI ≤ ${FLG2_cutoff}`) ? true : 'none')
      .style('color', '#379237')

  return table.node();
}

return {showNumbers,objNumbers,table3};
}});

define({id: "83de13cb", inputs: ["display","table3"], body: (display,table3) => {
display(table3())
}});

define({id: "91b773ac", inputs: ["joinedData","FLG2_cutoff","aq","_"], outputs: ["dataLong"], body: (joinedData,FLG2_cutoff,aq,_) => {
function dataLong() {
    const data = joinedData.map(d =>({
    ...d,
    'GROUP': d.FLG1 === 'No' & d.BMI > FLG2_cutoff 
            ?  `FLG1=No & BMI > ${FLG2_cutoff}`
            :  d.FLG1 === 'Yes' & d.BMI > FLG2_cutoff 
            ?  `FLG1=Yes & BMI > ${FLG2_cutoff}`
            :  d.FLG1 === 'No' & d.BMI <= FLG2_cutoff 
            ?  `FLG1=No & BMI ≤ ${FLG2_cutoff}`
            :  d.FLG1 === 'Yes' & d.BMI <= FLG2_cutoff 
            ?  `FLG1=Yes & BMI ≤ ${FLG2_cutoff}` : 'Other',
  }))

  const data1 = aq.from(data)
                      .groupby(['GROUP', 'AVALC'])
                      .rollup({numRS: aq.op.count()})  
                      .join(
                        aq.from(data)
                          .groupby(['GROUP'])
                          .rollup({numGrp: aq.op.count()}) ,
                        ['GROUP', 'GROUP']
                      )
                      .orderby([aq.desc('GROUP'), 'AVALC'])
                      .objects()

  const data2 = aq.from(data1.filter(d => ['CR', 'PR'].includes(d.AVALC)))
                  .groupby(['GROUP'])
                  .derive({
                    numORR: aq.op.sum('numRS'),
                  })
                  .objects()
                  .map(d => ({
                    ...d,
                    'rateORR' : (d.numORR / d.numGrp).toFixed(2)
                  }))

  const data3 = aq.from(data1).join(aq.from(data2).select(['GROUP', 'numORR', 'rateORR']), 
                                    ['GROUP', 'GROUP']
                                   ).objects()

    return _.uniqWith(data3, _.isEqual);
}
return {dataLong};
}});

define({id: "d404ba39", inputs: ["Plot","d3","dataLong","storedAdslInputs"], outputs: ["plot3"], body: (Plot,d3,dataLong,storedAdslInputs) => {
function plot3(){

  return Plot.plot({
              height : 500,
              width : 700,
              x: {
                axis: null,
                // domain: data.ages,
                domain: ['CR', 'PR', 'SD', 'PD', 'NE'],
              },
              y: {
                grid: true,
                // tickFormat: "s"
                domain: [0, d3.max(dataLong(), d=>d.numORR) + Math.floor(storedAdslInputs.enrollment * 0.04)],
                label: '↑ Response',
              },
              color: {
                // domain: dataLong.AVALC,
                domain: ['CR', 'PR', 'SD', 'PD', 'NE'],
                range: ['#59a14f', '#4e79a7', '#76b7b2', '#e15759', '#f28e2c'],
                // scheme: "tableau10",
                legend: true,
              },
              fx: {
                domain: d3.groupSort(dataLong(), v => d3.sum(v, d => -d.numGrp), d => d.GROUP),
                // domian: ['MARKFL1B=1 & MARKFL2=1', 'MARKFL1B=0 & MARKFL2=0', 'MARKFL1B=1 & MARKFL2=0', 'MARKFL1B=0 & MARKFL2=1'],
                label: null,
                // tickSize: 6
              },
              fy:{
                
              },
            //   facet: {
            //     data: dataLong(),
            //     x: d => d.GROUP,
            //     // color: 'GROUP',
            //     // x: ['MARKFL1B=1 & MARKFL2=1', 'MARKFL1B=0 & MARKFL2=0', 'MARKFL1B=1 & MARKFL2=0', 'MARKFL1B=0 & MARKFL2=1'],
            //   },
              marks: [
                Plot.barY(dataLong(), {x: "AVALC", y: "numRS", fill: "AVALC", title: "AVALC", opacity: 0.8, fx: "GROUP"}),
                Plot.text(dataLong(), {x: "AVALC", y: "numRS", 
                                     text: d=> d.numRS + '/' + d.numGrp, dy: -6,
                                     // fontWeight: 'bold',
                                     fill: '#333',
                                     fx: "GROUP",
                                    }),
                Plot.ruleX(dataLong(), 
                           {x: "AVALC", 
                            // y: d3.max(dataLong, d=>d.numRS) + 2,
                            y: d => d.AVALC == 'PR' ? d.numORR : 0,
                            dx: 14, 
                            stroke: '#999',
                            fx: "GROUP",
                           }),
                Plot.ruleX(dataLong(), 
                           {x: "AVALC", 
                             y: d => d.AVALC == 'CR' ? d.numORR : 0,
                            dx: -15, stroke: '#999', fx: "GROUP",
                           }),
                Plot.text(dataLong(), 
                           {x: d => d.AVALC == 'PR' ? d.AVALC : null, 
                            // y: d3.max(dataLong, d=>d.numRS) + 1.5, 
                            y: d => d.AVALC == 'PR' ? d.numORR + 1.5 : 0,
                            dx: 10, 
                            dy: -4,
                            fill: '#333',
                            text: d => 'ORR = ' + d.rateORR,
                            textAnchor: "end", fx: "GROUP",
                           }),
                Plot.text(dataLong(), 
                           {x: d => d.AVALC == 'PR' ? d.AVALC : null, 
                            // y: d3.max(dataLong, d=>d.numRS) + 1, 
                            y: d => d.AVALC == 'PR' ? d.numORR + 0.9 : 0,
                            dx: 2, 
                            fill: '#333',
                            text: d =>  `(${d.numORR} / ${d.numGrp})`,
                            textAnchor: "end", fx: "GROUP", dy: 2,
                           }),
                Plot.ruleY([0]),
              ]
            })
}
return {plot3};
}});

define({id: "5fd7d252", inputs: ["display","plot3"], body: (display,plot3) => {
display(plot3())
}});

define({id: "6b431568", inputs: ["aq","d3","storedAdslInputs"], outputs: ["ADTTE"], body: (aq,d3,storedAdslInputs) => {
const ADTTE = aq.table({
    USUBJID: d3.range(1,storedAdslInputs.enrollment+1).map(d => `Subject_${d.toString().padStart(3, '0')}`),
    AVAL: Array.from({length: storedAdslInputs.enrollment}, d3.randomInt(1, 24)),
    CNSR: Array.from({length: storedAdslInputs.enrollment}, d3.randomBinomial(1, 0.2)),
    PARAMCD: new Array(storedAdslInputs.enrollment).fill('PFS'),
  }).objects()

return {ADTTE};
}});

define({id: "7e1bccc2", mode: "inline", inputs: ["storedAdslInputs","display"], body: async (storedAdslInputs,display) => {
display(await(
storedAdslInputs.enrollment
))
}});

define({id: "577c49ed", mode: "inline", inputs: ["tex","display"], body: async (tex,display) => {
display(await(
tex`\small1 \le x \le 24`
))
}});

define({id: "fcdd803e", inputs: ["Inputs","ADTTE","display"], body: async (Inputs,ADTTE,display) => {
display(await(
Inputs.table(ADTTE)
))
}});

define({id: "432019f6", inputs: ["SummaryTable","ADTTE","display"], body: async (SummaryTable,ADTTE,display) => {
display(await(
SummaryTable(ADTTE, {label: "ADTTE"})
))
}});

define({id: "7e1bccc2-1", mode: "inline", inputs: ["storedAdslInputs","display"], body: async (storedAdslInputs,display) => {
display(await(
storedAdslInputs.enrollment
))
}});

define({id: "3e94ca3a", inputs: ["SJS","storedAdslInputs","_","aq","d3"], outputs: ["probs","mult","rs","r","rsArray","ADRS"], body: (SJS,storedAdslInputs,_,aq,d3) => {
  
const probs = [0.2, 0.4, 0.2, 0.1, 0.1]
const mult = SJS.Multinomial(storedAdslInputs.enrollment, probs).draw()
const rs = ['CR', 'PR', 'SD', 'PD', 'NE']
let r = []

mult.map((d,i) => {
r.push(...new Array(d).fill(rs[i]))
})

const rsArray = _.shuffle(r)
  
  
const ADRS = aq.table({
    USUBJID: d3.range(1, storedAdslInputs.enrollment + 1).map(d => `Subject_${d.toString().padStart(3, '0')}`),
    AVALC: rsArray,
    PARAMCD: new Array(storedAdslInputs.enrollment).fill('BESTRESP'),
  })
  .objects()
 
return {probs,mult,rs,r,rsArray,ADRS};
}});

define({id: "5f0f2441", inputs: ["Inputs","ADRS","display"], body: async (Inputs,ADRS,display) => {
display(await(
Inputs.table(ADRS)
))
}});

define({id: "9604ad96", inputs: ["SummaryTable","ADRS","display"], body: async (SummaryTable,ADRS,display) => {
display(await(
SummaryTable(ADRS, {label: "ADRS"})
))
}});

</script>
<input id="observablehq-sidebar-toggle" type="checkbox" title="Toggle sidebar">
<label id="observablehq-sidebar-backdrop" for="observablehq-sidebar-toggle"></label>
<nav id="observablehq-sidebar">
  <ol>
    <label id="observablehq-sidebar-close" for="observablehq-sidebar-toggle"></label>
    <li class="observablehq-link"><a href="./">Clinical Trial Data Analysis</a></li>
  </ol>
  <section>
    <summary class="observablehq-link"><a href="./Enrollment-Monitoring">Enrollment Monitoring</a></summary>
    <ol>
    </ol>
  </section>
  <section>
    <summary>Analytical Data Simulation</summary>
    <ol>
    <li class="observablehq-link"><a href="./ADaM-Datasets">ADaM Datasets</a></li>
    <li class="observablehq-link"><a href="./Master-Dataset">Master Dataset</a></li>
    </ol>
  </section>
  <section class="observablehq-section-active">
    <summary>Dynamic Analysis</summary>
    <ol>
    <li class="observablehq-link"><a href="./Descriptive-Statistics">Descriptive Statistics</a></li>
    <li class="observablehq-link"><a href="./Summerized-Information">Summarized Information</a></li>
    <li class="observablehq-link observablehq-link-active"><a href="./Efficacy-Analyses">Efficacy Analyses</a></li>
    </ol>
  </section>
  <section>
    <summary>Output Tables</summary>
    <ol>
    <li class="observablehq-link"><a href="./Demographic-Table">Demographic Table</a></li>
    <li class="observablehq-link"><a href="./Primary-Table">Primary Table</a></li>
    <li class="observablehq-link"><a href="./Followup-Table">Visit Completion Table</a></li>
    </ol>
  </section>
  <section>
    <summary class="observablehq-link"><a href="./About-Author">About the Author</a></summary>
    <ol>
    </ol>
  </section>
</nav>
<script>{Object.assign(document.createElement("a"),{href:""}).password&&location.replace(location.href);const e=document.querySelector("#observablehq-sidebar"),t=document.querySelector("#observablehq-sidebar-toggle"),r=sessionStorage.getItem("observablehq-sidebar");r?t.checked=r==="true":t.indeterminate=!0;for(const o of document.querySelectorAll("#observablehq-sidebar summary")){const s=o.parentElement;switch(sessionStorage.getItem(`observablehq-sidebar:${o.textContent}`)){case"true":s.open=!0;break;case"false":s.classList.contains("observablehq-section-active")||(s.open=!1);break}}addEventListener("beforeunload",()=>sessionStorage.setItem("observablehq-sidebar-scrolly",`${e.scrollTop}`));const a=sessionStorage.getItem("observablehq-sidebar-scrolly");a!=null&&(e.style.cssText="overflow: hidden;",e.scrollTop=+a,e.style.cssText="");}</script>
<aside id="observablehq-toc" data-selector="h1:not(:first-of-type)[id], h2:first-child[id], :not(h1) + h2[id]">
<nav>
<div>Contents</div>
<ol>
<li class="observablehq-secondary-link"><a href="#kaplan-meier-curves-for-pfs-os-do-r">Kaplan-Meier Curves (for PFS/OS/DoR)</a></li>
<li class="observablehq-secondary-link"><a href="#objective-response-rate-orr">Objective Response Rate (ORR)</a></li>
<li class="observablehq-secondary-link"><a href="#two-more-simulated-a-da-m-datasets">Two More Simulated ADaM Datasets</a></li>
</ol>
</nav>
</aside>
<div id="observablehq-center">
<main id="observablehq-main" class="observablehq">
<div class="observablehq observablehq--block"><!--:f7ba7a53:--></div>
<div class="observablehq observablehq--block"><!--:48070a84:--></div>
<h1 id="an-interactive-tool-for-efficacy-analyses" tabindex="-1"><a class="observablehq-header-anchor" href="#an-interactive-tool-for-efficacy-analyses">An Interactive Tool for Efficacy Analyses</a></h1>
<br>
<blockquote>
<p>Efficacy analyses for new targeted treatment in early phase usually require close collaboration between the biometric team and the clinical development team to identify delicate signals hidden in patient subgroups defined by biomarkers. The conventional communication paradigm, based on pre-planned TLF (tables, listings, and figures) deliverables, is often inefficient.</p>
</blockquote>
<blockquote>
<p>A flexible presentation of PFS/OS/ORR/DoR data is very much desired to facilitate communication among a drug development team. Below is a demonstration of a dynamic tool to allow highly customizable statistical analyses for efficacy endpoints commonly seen in an oncology trial.</p>
</blockquote>
<blockquote>
<p>Beginning with a set of validated ADaM data (<a href="#two-more-simulated-a-da-m-datasets">simulated in this instance</a>), what types of analyses would you be interested in exploring? Feel free to utilize the various analytical tools provided below for your investigation.</p>
</blockquote>
<hr>
<h1 id="kaplan-meier-curves-for-pfs-os-do-r" tabindex="-1"><a class="observablehq-header-anchor" href="#kaplan-meier-curves-for-pfs-os-do-r">Kaplan-Meier Curves (for PFS/OS/DoR)</a></h1>
<blockquote>
<p>Two biomarkers are simulated: FLG1, a binary marker in ADSL, and FLG2, another binary marker for the targeted treatment, defined by applying a cut-off value to BMI. You can adjust the cut-off value here:</p>
</blockquote>
<div class="observablehq observablehq--block"><!--:fc3d1856:--></div>
<blockquote>
<p>Count by Flags</p>
</blockquote>
<table style="width:35%; border: 1px solid #ccc;">
  <tbody><tr style="background: #eee; border:  1px solid #ccc;">
    <td></td>
    <td style="border: 1px solid #ccc;">FLG1=No</td>
    <td style="border: 1px solid #ccc;">FLG1=Yes</td>
    <td style="border: 1px solid #ccc;">TOTAL</td>
  </tr>
  <tr style="border: 1px solid #ccc;">
    <td style="background: #eee;">BMI <observablehq-loading></observablehq-loading><!--:45cdaf97:--> <observablehq-loading></observablehq-loading><!--:c76bcdfc:--></td>
    <td style="border: 1px solid #ccc; color: #FD841F; font-weight: bold;"><observablehq-loading></observablehq-loading><!--:b32a4a78:--></td>
    <td style="border: 1px solid #ccc; color: #3E6D9C; font-weight: bold;"><observablehq-loading></observablehq-loading><!--:d791d065:--></td>
    <td style="border: 1px solid #ccc; color: #666; font-weight: bold;"><observablehq-loading></observablehq-loading><!--:22f14433:--></td>
  </tr>
  <tr style="border: 1px solid #ccc;">
    <td style="background: #eee; ">BMI <observablehq-loading></observablehq-loading><!--:2947d3ce:--> <observablehq-loading></observablehq-loading><!--:c76bcdfc-1:--></td>
    <td style="border: 1px solid #ccc; color: #379237; font-weight: bold;"><observablehq-loading></observablehq-loading><!--:0fec3de8:--></td>
    <td style="border: 1px solid #ccc; color: #E14D2A; font-weight: bold;"><observablehq-loading></observablehq-loading><!--:9e29af2e:--></td>
    <td style="border: 1px solid #ccc; color: #666;  font-weight: bold;"><observablehq-loading></observablehq-loading><!--:b9ac865d:--></td>
  </tr>
  <tr style="border: 1px solid #ccc;">
    <td style="background: #eee; ">TOTAL</td>
    <td style="border: 1px solid #ccc; color: #666; font-weight: bold;"><observablehq-loading></observablehq-loading><!--:7222c8b9:--></td>
    <td style="border: 1px solid #ccc; color: #666; font-weight: bold;"><observablehq-loading></observablehq-loading><!--:75421d74:--></td>
    <td style="border: 1px solid #ccc; color: #666; font-weight: bold;"><observablehq-loading></observablehq-loading><!--:76b18840:--></td>
  </tr>
</tbody></table>
<br>
<div class="observablehq observablehq--block"><!--:0f4e6142:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:72cc7b57:--></div>
<p><strong>Follow each patient for a maximum of <observablehq-loading></observablehq-loading><!--:a5c7d171:--> months</strong></p>
<div class="observablehq observablehq--block"><!--:e77c52b2:--></div>
<div class="observablehq observablehq--block"><!--:1b77f44b:--></div>
<div class="observablehq observablehq--block"><!--:01ba4719:--></div>
<div class="observablehq observablehq--block"><!--:b32a9271:--></div>
<div class="observablehq observablehq--block"><!--:413bb80d:--></div>
<br>
<p><strong>Number of subjects still at risk</strong></p>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:d68148d1:--></div>
<div class="observablehq observablehq--block"><!--:ae61d176:--></div>
<div class="observablehq observablehq--block"><!--:fb4f551b:--></div>
<br>
<p><strong>Median and Hazard Ratio</strong></p>
<div class="observablehq observablehq--block"><!--:04ab8565:--></div>
<br>
<p><strong>Event and Censored</strong></p>
<div class="observablehq observablehq--block"><!--:ad6ae6f7:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:83de13cb:--></div>
<br>
<hr>
<h1 id="objective-response-rate-orr" tabindex="-1"><a class="observablehq-header-anchor" href="#objective-response-rate-orr"><strong>Objective Response Rate (ORR)</strong></a></h1>
<blockquote>
<p>The bar chart displays the ORR results for each subgroup based on The Response Evaluation Criteria in Solid Tumors (RECIST), including Complete Response (CR), Partial Response (PR), Stable Disease (SD), Progressive Disease (PD), and Not Evaluable (NE). The chart also presents the count and rate of ORR, calculated as the sum of complete and partial responses.</p>
</blockquote>
<div class="hl">
<blockquote>
  <p>Since the chart is dynamic, it can be applied to any subgroup analysis, providing flexibility for both the biometrics and clinical development teams to efficiently explore and interpret data across different patient populations..</p>
</blockquote>
</div>
<div class="observablehq observablehq--block"><!--:91b773ac:--></div>
<div class="observablehq observablehq--block"><!--:d404ba39:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:5fd7d252:--></div>
<hr>
<h1 id="two-more-simulated-a-da-m-datasets" tabindex="-1"><a class="observablehq-header-anchor" href="#two-more-simulated-a-da-m-datasets">Two More Simulated ADaM Datasets</a></h1>
<br>
<h3 id="adtte" tabindex="-1"><a class="observablehq-header-anchor" href="#adtte">ADTTE</a></h3>
<div class="observablehq observablehq--block"><!--:6b431568:--></div>
<ul>
<li><strong>USUBJID</strong>: dynamic ITT with default sample size = <observablehq-loading></observablehq-loading><!--:7e1bccc2:--></li>
<li><strong>AVAL</strong>: integer samples from a uniform distribution <observablehq-loading></observablehq-loading><!--:577c49ed:--></li>
<li><strong>CNSR</strong>: samples from a binomial distribution (n = 1, p = 0.2)</li>
<li><strong>PARAMCD</strong>: flag for endpoint</li>
</ul>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:fcdd803e:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:432019f6:--></div>
<br>
<h3 id="adrs" tabindex="-1"><a class="observablehq-header-anchor" href="#adrs">ADRS</a></h3>
  <ul>
    <li><b>USUBJID</b>: dynamic ITT with default sample size = <observablehq-loading></observablehq-loading><!--:7e1bccc2-1:--></li>
    <li><b>AVALC</b>: 'SD', 'CR', 'PR', 'PD', 'NE' simulated by using multinomial distribution with prob = [0.2, 0.4, 0.2, 0.1, 0.1] </li>
    <li><b>PARAMCD</b>: flag for response criteria</li>
  </ul>
<div class="observablehq observablehq--block"><!--:3e94ca3a:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:5f0f2441:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:9604ad96:--></div>
<style>
.hl blockquote {
	padding: 1em;
	border-left: 5px solid #1E4865;
}

.summaryTable td:first-child {
	text-align:left;
}

th, tr, td {
   text-align: center; 
}

span[style*="rotate(90deg)"] {
	display: none !important;
}

</style>
</main>
<footer id="observablehq-footer">
<nav><a rel="prev" href="./Summerized-Information"><span>Summarized Information</span></a><a rel="next" href="./Demographic-Table"><span>Demographic Table</span></a></nav>
</footer>
</div>
